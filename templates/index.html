<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Waste Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #121212; color: #e0e0e0; font-family: Arial, sans-serif; margin:0; padding:0; }
        header, footer { background-color:#1e1e1e; padding:1rem; text-align:center; }
        main { padding:1rem 2rem; }
        table { width:100%; border-collapse:collapse; margin-bottom:1.5rem; }
        th, td { border:1px solid #333; padding:0.5rem; text-align:left; }
        th { background-color:#333; }
        input, select, button { padding:0.5rem; margin:0.25rem 0; background-color:#1e1e1e; color:#e0e0e0; border:1px solid #555; }
        button { cursor:pointer; }
        button:hover { background-color:#333; }
        .summary { display:flex; flex-wrap:wrap; gap:2rem; margin-bottom:1.5rem; }
        .summary div { background-color:#1e1e1e; padding:1rem; border-radius:8px; flex:1; min-width:150px; }
        .warning { color:#ff5555; font-weight:bold; }
    </style>
</head>
<body>
<header>
    <h1>Waste Tracker</h1>
</header>
<main>
    {% if usage_percent >= 80 %}
        <p class="warning">⚠️ On-site capacity is at {{ usage_percent|round(1) }}%! Consider reducing waste.</p>
    {% endif %}
    <form method="POST">
        <label for="date">Date:</label>
        <input type="date" name="date" value="{{ default_date }}">

        <label for="business">Business:</label>
        <select name="business" required>
            {% for b in businesses %}
                <option value="{{ b }}">{{ b }}</option>
            {% endfor %}
        </select>

        <label for="stream">Stream:</label>
        <select name="stream" required>
            {% for s in streams %}
                <option value="{{ s }}">{{ s }}</option>
            {% endfor %}
        </select>

        <label for="quantity">Quantity (kg):</label>
        <input type="number" step="0.01" name="quantity" required>

        <button type="submit">Add Entry</button>
    </form>

    <div class="summary">
        <div>
            <h3>Total Quantity</h3>
            <p>{{ total }} kg</p>
            <progress value="{{ total }}" max="1000"></progress>
        </div>
        {% for b, qty in business_totals.items() %}
        <div>
            <h3>{{ b }}</h3>
            <p>{{ qty }} kg</p>
        </div>
        {% endfor %}
    </div>

    <h2>Waste by Stream</h2>
    <canvas id="streamChart"></canvas>
    <h2>Waste by Business</h2>
    <canvas id="businessChart"></canvas>

    <h2>Monthly Summary</h2>
    <table>
        <thead>
            <tr>
                <th>Date</th>
                <th>Business</th>
                <th>Stream</th>
                <th>Quantity (kg)</th>
            </tr>
        </thead>
        <tbody>
            {% for row in summary %}
            <tr>
                <td>{{ row[0] }}</td>
                <td>{{ row[1] }}</td>
                <td>{{ row[2] }}</td>
                <td>{{ row[3] }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <a href="{{ url_for('export_csv') }}"><button>Export CSV</button></a>

    <script>
        const ctxStream = document.getElementById('streamChart').getContext('2d');
        const streamChart = new Chart(ctxStream, {
            type: 'bar',
            data: {
                labels: {{ stream_totals.keys()|list|tojson }},
                datasets: [{ label: 'Quantity (kg)', data: {{ stream_totals.values()|list|tojson }}, backgroundColor: '#bb86fc' }]
            },
            options: { responsive:true, plugins:{legend:{labels:{color:'#e0e0e0'}}}, scales:{x:{ticks:{color:'#e0e0e0'}, grid:{color:'#333'}}, y:{ticks:{color:'#e0e0e0'}, grid:{color:'#333'}}} }
        });

        const ctxBusiness = document.getElementById('businessChart').getContext('2d');
        const businessChart = new Chart(ctxBusiness, {
            type: 'pie',
            data: {
                labels: {{ business_totals.keys()|list|tojson }},
                datasets: [{ label: 'Quantity (kg)', data: {{ business_totals.values()|list|tojson }}, backgroundColor: ['#bb86fc','#03dac6','#cf6679','#ffb86c'] }]
            },
            options: { responsive:true, plugins:{legend:{labels:{color:'#e0e0e0'}}} }
        });
    </script>
</main>
<footer>
    &copy; {{ default_date[:4] }} Waste Tracker
</footer>
</body>
</html>
